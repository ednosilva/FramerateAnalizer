@using FPSAnalizer
@using Plotly.Blazor
@using Plotly.Blazor.ConfigLib
@using Plotly.Blazor.LayoutLib
@using Plotly.Blazor.Traces
@using Plotly.Blazor.Traces.BarLib

<MudContainer Class="d-flex justify-center align-center" Style="width: 100%">
    <PlotlyChart style="width:1650px" @bind-Config="config" @bind-Layout="layout" @bind-Data="data" @ref="chart" />
</MudContainer>

@code {
    [Parameter] public List<FramerateCapture> Captures { get; set; }

    private PlotlyChart chart;
    private Config config;
    private Layout layout;
    private IList<ITrace> data;

    protected override void OnInitialized()
    {
        config = new Config
        {
            Responsive = true,
            Editable = false,
            DisplayModeBar = DisplayModeBarEnum.False
        };

        layout = new Layout
        {
            Title = new Title
            {
                Text = GetType().Name
            },
            BarMode = BarModeEnum.Stack,
            Margin = new Plotly.Blazor.LayoutLib.Margin
            {
                L = 200,
                R = 40,
                T = 40,
                B = 40
            }
        };

        data = CreateChartData();

        base.OnInitialized();
    }

    private List<ITrace> CreateChartData()
    {
        List<ITrace> Data = new List<ITrace>();

        var capturesByCpu = Captures
            .GroupBy(c => new { c.Cpu })
            .ToList();

        foreach (var cpuGroup in capturesByCpu)
        {
            var cpuCaptures = Captures.Where(x => x.Cpu == cpuGroup.Key.Cpu).ToList();

            FramerateAggregatedPerformance framerateAggregatedPerformance = new FramerateAggregatedPerformance(cpuCaptures);

            Data.Add(new Bar
            {
                Name = $"FPS 0.1% - {cpuGroup.Key.Cpu}",
                X = new List<object> { cpuGroup.Average(x => x.ZeroPointOnePercentLowFramerate) },
                Y = new List<object> { cpuGroup.Key.Cpu },
                Orientation = OrientationEnum.H,
                Marker = new Marker { Color = "#ff4d00" },
                Text = $"{cpuGroup.Average(x => x.ZeroPointOnePercentLowFramerate).ToString("F1")}",
                TextPosition = TextPositionEnum.Inside,
                Width = 0.1m
            });

            Data.Add(new Bar
            {
                Name = $"FPS 1% - {cpuGroup.Key.Cpu}",
                X = new List<object> { cpuGroup.Average(x => x.OnePercentLowFramerate) },
                Y = new List<object> { cpuGroup.Key.Cpu },
                Orientation = OrientationEnum.H,
                Marker = new Marker { Color = "#ff7f0e" },
                Text = $"{cpuGroup.Average(x => x.OnePercentLowFramerate).ToString("F1")}",
                TextPosition = TextPositionEnum.Inside,
                Width = 0.1m
            });

            Data.Add(new Bar
            {
                Name = $"FPS 10% - {cpuGroup.Key.Cpu}",
                X = new List<object> { cpuGroup.Average(x => x.TenPercentLowFramerate) },
                Y = new List<object> { cpuGroup.Key.Cpu },
                Orientation = OrientationEnum.H,
                Marker = new Marker { Color = "#2ca02c" },
                Text = $"{cpuGroup.Average(x => x.TenPercentLowFramerate).ToString("F1")}",
                TextPosition = TextPositionEnum.Inside,
                Width = 0.1m
            });

            Data.Add(new Bar
            {
                Name = $"FPS Avg - {cpuGroup.Key.Cpu}",
                X = new List<object> { framerateAggregatedPerformance.FramerateGeomeanStats.AggregatedPerformance() },
                Y = new List<object> { cpuGroup.Key.Cpu },
                Orientation = OrientationEnum.H,
                Marker = new Marker { Color = "#1f77b4" },
                Text = $"{framerateAggregatedPerformance.FramerateGeomeanStats.AggregatedPerformance().ToString("F1")}",
                TextPosition = TextPositionEnum.Inside,
                Width = 0.1m
            });
        }

        return Data;
    }
}
