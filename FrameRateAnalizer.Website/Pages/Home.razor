@page "/"

@using FrameRateAnalizer.Infrastructure
@using FramerateAnalyzer.Domain
@using FramerateAnalyzer.Infrastructure
@using MudBlazor
@using System.Text.Json
@using System.Globalization

@inject IJSRuntime JS
@inject ISnackbar Snackbar

<PageTitle>Home</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudStack>
        <MudPaper Elevation="0" Outlined Class="mt-2">
            <MudDataGrid T="FramerateCapture" Items="@Captures" RowClick="@RowClicked" Height="303px" Style="table-layout: fixed;"
                         Loading="loading" Dense Hover FixedHeader Groupable>
                <ToolBarContent>
                    <MudStack Row AlignItems="AlignItems.Center" Class="w-100">

                        <MudStack Row Spacing="2">
                            <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                                           Accept=".json"
                                           FilesChanged="UploadFiles"
                                           AppendMultipleFiles="true"
                                           MaximumFileCount="100">
                                <ActivatorContent>
                                    <MudButton Variant="Variant.Filled"
                                               Color="MudBlazor.Color.Primary"
                                               StartIcon="@Icons.Material.Filled.CloudUpload"
                                               Style="width:200px">
                                        Load Files
                                    </MudButton>
                                </ActivatorContent>
                            </MudFileUpload>

                            @if (Captures.Any())
                            {
                                <MudButton Variant="Variant.Filled"
                                           Color="MudBlazor.Color.Secondary"
                                           OnClick="CopyToClipboard"
                                           Style="width:200px">
                                    Report Performance
                                </MudButton>
                            }
                        </MudStack>

                        <MudSpacer />

                        @if (Captures.Any())
                        {
                            <MudStack Row Spacing="2">
                                <MudSelect @bind-Value="selectedGame"
                                           Label="Games"
                                           FullWidth="false">
                                    @foreach (var game in games)
                                    {
                                        <MudSelectItem Value="@game">@game</MudSelectItem>
                                    }
                                </MudSelect>

                                <MudSelect @bind-Value="selectedGameSettings"
                                           Label="Graphic Settigns"
                                           FullWidth="false">
                                    @foreach (var setting in gameSettings)
                                    {
                                        <MudSelectItem Value="@setting">@setting</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudStack>
                        }
                    </MudStack>
                </ToolBarContent>
                <Columns>
                    <PropertyColumn Property="x => x.GameName" Title="Game" />
                    <PropertyColumn Property="x => x.GameSettings" Title="Game Settings" />
                    <PropertyColumn Property="x => x.Cpu" Title="CPU" />
                    <PropertyColumn Property="x => x.Gpu" Title="GPU" />
                    <PropertyColumn Property="x => x.Memory" Title="Memory" />
                    <PropertyColumn Property="x => x.Stats.Average" Title="Avg FPS" Culture="cultureInfo"
                        Format="F1" CellStyle="text-align: right;" />
                    <PropertyColumn Property="x => x.Stats.TenPercentLowAverage" Title="10% Low FPS"
                        Culture="cultureInfo" Format="F1" CellStyle="text-align: right;" />
                    <PropertyColumn Property="x => x.Stats.OnePercentLowAverage" Title="1% Low FPS"
                        Culture="cultureInfo" Format="F1" CellStyle="text-align: right;" />
                    <PropertyColumn Property="x => x.Stats.ZeroPointOnePercentLowAverage" Title="0.1% Low FPS"
                        Culture="cultureInfo" Format="F1" CellStyle="text-align: right;" />
                </Columns>
            </MudDataGrid>
        </MudPaper>

        @if (CaptureGroups.Any())
        {
            <MudPaper Elevation="0" Outlined Class="mt-2">
                <MudGrid>
                    <MudItem xs="12" lg="6">
                        <MudPaper Elevation="0">
                            <FramerateChart CaptureGroups="CaptureGroups"/>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" lg="6">
                        <MudPaper Elevation="0">
                            <AggregatedFramerateChart CaptureGroups="CaptureGroups" />
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" lg="6">
                        <MudPaper Elevation="0">
                            <RelativePerformanceChart CaptureGroups="CaptureGroups" />
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
    </MudStack>
</MudContainer>
<script>
        window.copyToClipboard = async (text) => {

        if (navigator.clipboard) {
            await navigator.clipboard.writeText(text);
            return true;
        }

        const textarea = document.createElement("textarea");

        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);

        return true;
    };
</script>

@code {
    CultureInfo cultureInfo = CultureInfo.InvariantCulture;

    public IList<CapFrameXData> Data { get; set; } = [];

    IList<FramerateCapture> Captures = [];

    IList<FramerateCaptureGroup> CaptureGroups = [];

    //IList<ChartSeries> selectedFrameTime;

    //CapFrameXData selectedRow = new CapFrameXData();

    //List<decimal> frameTimes = new List<decimal>();
    IList<IBrowserFile> files = new List<IBrowserFile>();

    List<string> games = [];
    List<string> gameSettings = [];

    string selectedGame = string.Empty;
    string selectedGameSettings = string.Empty;

    bool loading;

    private async Task UploadFiles(IReadOnlyList<IBrowserFile> files)
    {
        loading = true;

        if (Data.Any() && Captures.Any())
        {
            var duplicatedFiles = files
                .GroupBy(f => f.Name)
                .Where(g => g.Count() > 1)
                .SelectMany(g => g)
                .ToList();

            if (duplicatedFiles.Any()) return;

            files = files.Where(f => !Data.Select(d => d.FileName).Contains(f.Name)).ToList();
        }

        var capFrameXReader = new FramerateCaptureReader();

        foreach (var file in files)
        {
            await using var stream = file.OpenReadStream(20 * 1024 * 1024);

            var result = await capFrameXReader.ReadFile(stream, file.Name);

            if (result != null)
                Data.Add(result);
        }

        Captures = capFrameXReader.GetFramerateCaptures(Data);
        CaptureGroups = FramerateCaptureGroupFactory.Create(Captures);

        loading = false;

        games = Captures
            .Select(x => x.GameName)
            .Distinct()
            .ToList();

        gameSettings = Captures
            .Select(x => x.GameSettings)
            .Distinct()
            .ToList();
    }

    private async Task CopyToClipboard()
    {
        FramerateCaptureGroup referenceCaptureGroup = CaptureGroups
            .OrderByDescending(games => games.Stats.AggregatedFramerate)
            .First();

        string report = new AggregatePerformanceReporter()
        .ReportPerformance(CaptureGroups, referenceCaptureGroup, ";");

        await JS.InvokeVoidAsync("navigator.clipboard.writeText", report);
        Snackbar.Add("Copied!", Severity.Success);
    }

    private async Task RowClicked(DataGridRowClickEventArgs<FramerateCapture> args)
    {
        //var capture = args.Item;
        //var data = Data.FirstOrDefault(x => x.FileName == capture.FileName);

        //selectedRow = data;
    }
}