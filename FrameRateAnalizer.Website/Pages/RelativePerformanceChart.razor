@using AntDesign
@using AntDesign.Charts
@using FramerateAnalyzer.Domain
@using System.Threading.Tasks
@using System.Text.Json
@using Title = AntDesign.Charts.Title

@* <ApexChart @ref="chart" TItem="FramerateCaptureGroup" Title="Relativae Performance" Options=options OnDataPointSelection="DataPointSelected">
    <ApexPointSeries TItem="FramerateCaptureGroup"
                    Items="CaptureGroups"
                    Name="Relative Performance"
                    SeriesType="SeriesType.Bar"
                    XValue="@(e => e.BenchmarkedParts)"
                    YAggregate="@(e => (decimal)e.Sum(g => g.RelativePerformance(referenceCaptureGroup).AggregatedFramerate))"
                    ShowDataLabels />
</ApexChart>

@code {
    [Parameter]
    public IList<FramerateCaptureGroup> CaptureGroups { get; set; }

    IDictionary<FramerateCaptureGroup, double> groups = new Dictionary<FramerateCaptureGroup, double>();

    private ApexChart<FramerateCaptureGroup> chart;

    private ApexChartOptions<FramerateCaptureGroup> options;

    private FramerateCaptureGroup referenceCaptureGroup;

    decimal maxBarHeight = 1;

    protected override void OnInitialized()
    {
        referenceCaptureGroup = CaptureGroups.First();

        options = new ApexChartOptions<FramerateCaptureGroup>
        {
            Chart = new ApexCharts.Chart
            {
                Stacked = false,
                StackType = StackType.Percent100,
                Toolbar = new Toolbar
                {
                    Show = false
                },
                Height = CaptureGroups.Count * 80 + 100
            },
            PlotOptions = new PlotOptions
            {
                Bar = new PlotOptionsBar
                {
                    Horizontal = true,
                    BarHeight = "40%",
                    DataLabels = new PlotOptionsBarDataLabels
                    {
                        Position = BarDataLabelPosition.Top
                    }
                }
            },
            Xaxis = new XAxis
            {
                Labels = new XAxisLabels
                {
                    Style = new AxisLabelStyle
                    {
                        FontSize = "0.875rem",
                        FontWeight = 500,
                    },
                    Show = false
                },
                Categories = CaptureGroups.Select(g => g.BenchmarkedParts.Split("-"))
            },
            Yaxis = new List<YAxis> { 
                new YAxis
                {
                    Labels = new YAxisLabels {
                        MaxWidth = 320,
                        Style = new AxisLabelStyle {
                            FontSize = "0.875rem",
                            FontWeight = 500
                        } 
                    },
                    DecimalsInFloat = 1
                }
            },
            Legend = new ApexCharts.Legend
            {
                Position = LegendPosition.Top
            },
            DataLabels = new DataLabels
            {
                Formatter = "function (val) { return (val * 100).toFixed(1) + '%'; }",
                OffsetX = -25
            },
            Colors = [Colors.Blue.Darken3],
            Tooltip = new ApexCharts.Tooltip
            {
                Enabled = false
            },
        };

        base.OnInitialized();
    }

    public async Task DataPointSelected(SelectedData<FramerateCaptureGroup> selectedData)
    {
        if (selectedData != null)
        {
            var newReferenceCaptureGroup = (FramerateCaptureGroup)selectedData.DataPoint.Items.First();

            if (!referenceCaptureGroup.Equals(newReferenceCaptureGroup))
            {
                referenceCaptureGroup = newReferenceCaptureGroup;

                await RelativePerformance();

                options.Xaxis.Max = groups.First();

                await chart.RenderAsync();
            }
        }
    }

    private async Task RelativePerformance()
    {
        groups.Clear();

        foreach (var group in CaptureGroups)
        {
            var relativePerformance = group.RelativePerformance(referenceCaptureGroup).AggregatedFramerate;

            groups.Add(group, relativePerformance);
        }

        groups = groups.OrderByDescending(g => g.Value).ToDictionary();
    }
} *@


<Tabs Class="mx-7">
    <TabPane Key="1">
        <TabTemplate>Relative Performance</TabTemplate>
        <ChildContent>
            <Bar Data="data1" Config="config1" />
        </ChildContent>
    </TabPane>
</Tabs>

@code {
    [Parameter]
    public IList<FramerateCaptureGroup> CaptureGroups { get; set; }

    List<object> data1 = new();

    private FramerateCaptureGroup referenceCaptureGroup;

    protected override void OnInitialized()
    {
        foreach (var group in CaptureGroups)
        {
            referenceCaptureGroup = CaptureGroups.First();

            List<object> data = new List<object>()
            {
                new
                {
                    title = group.BenchmarkedParts,
                    label = group.BenchmarkedParts,
                    data = Math.Round(group.RelativePerformance(referenceCaptureGroup).AggregatedFramerate, 1)
                }
            };

            data1.AddRange(data);
        }
    }

    readonly BarConfig config1 = new BarConfig
    {
        Title = new Title
        {
            Visible = true,
            Text = "Relative Performance"
        },
        XField = "data",
        YField = "title",
        ConversionTag = new ConversionTagOptions
        {
            Visible = true
        }
    };
}