@using ApexCharts
@using FramerateAnalyzer.Domain
@using System.Threading.Tasks

<ApexChart @ref="chart"
           TItem="FrameRateBenchmarkResult"
           Title="@Title"
           Options=options
           OnDataPointSelection="DataPointSelected">
    <ApexPointSeries TItem="FrameRateBenchmarkResult"
                     Items="BenchmarkResults"
                     Name="Relative Performance"
                     SeriesType="SeriesType.Bar"
                     XValue="@(e => e.BenchmarkedParts)"
                     YAggregate="@(e => (decimal)e.Sum(g => g.Stats.RelativePerformance(referenceBenchmarkResults.Stats).AggregatedFrameRate))"
                     ShowDataLabels />
</ApexChart>

@code {
        [Parameter]
        public string? Title { get; set; }

        [Parameter]
        public IList<FrameRateBenchmarkResult> BenchmarkResults { get; set; }

    //IDictionary<FrameRateCaptureGroup, double> groups = new Dictionary<FrameRateCaptureGroup, double>();

    private ApexChart<FrameRateBenchmarkResult> chart;

    private ApexChartOptions<FrameRateBenchmarkResult> options;

    private FrameRateBenchmarkResult referenceBenchmarkResults;

    //decimal maxBarHeight = 1;

    protected override void OnInitialized()
    {
        referenceBenchmarkResults = BenchmarkResults
            .OrderByDescending(r => r.Stats.AggregatedFrameRate)
            .First();

        options = new ApexChartOptions<FrameRateBenchmarkResult>
        {
            Title = new Title
            {
                Align = ApexCharts.Align.Center
            },
            Chart = new Chart
            {
                Stacked = false,
                StackType = StackType.Percent100,
                Toolbar = new Toolbar
                {
                    Show = false
                },
                Height = BenchmarkResults.Count * 100 + 100
            },
            PlotOptions = new PlotOptions
            {
                Bar = new PlotOptionsBar
                {
                    Horizontal = true,
                    BarHeight = "40%",
                    DataLabels = new PlotOptionsBarDataLabels
                    {
                        Position = BarDataLabelPosition.Top
                    }
                }
            },
            Xaxis = new XAxis
            {
                Labels = new XAxisLabels
                {
                    Style = new AxisLabelStyle
                    {
                        FontSize = "0.875rem",
                        FontWeight = 500,
                    },
                    Show = false
                },
                Categories = BenchmarkResults.Select(g => g.BenchmarkedParts).ToList()
            },
            Yaxis = new List<YAxis> { 
                new YAxis
                {
                    Labels = new YAxisLabels {
                        MaxWidth = 320,
                        Style = new AxisLabelStyle {
                            FontSize = "0.875rem",
                            FontWeight = 500
                        } 
                    },
                    DecimalsInFloat = 1,
                    Max = GetMaxY()
                }
            },
            Legend = new Legend
            {
                Position = LegendPosition.Top
            },
            DataLabels = new DataLabels
            {
                Formatter = "function (val) { return (val * 100).toFixed(1) + '%'; }",
                OffsetX = -25
            },
            Colors = [Colors.Blue.Darken3],
            Tooltip = new ApexCharts.Tooltip
            {
                Enabled = false
            },
        };

        base.OnInitialized();
    }

    public async Task DataPointSelected(SelectedData<FrameRateBenchmarkResult> selectedData)
    {
        if (selectedData != null)
        {
            var newReferenceFrameRateBenchmarkResult = (FrameRateBenchmarkResult)selectedData.DataPoint.Items.First();

            if (!referenceBenchmarkResults.Equals(newReferenceFrameRateBenchmarkResult))
            {
                referenceBenchmarkResults = newReferenceFrameRateBenchmarkResult;

                options.Xaxis.Max = GetMaxY();

                await chart.RenderAsync();
            }
        }
    }

    private double GetMaxY()
    {
        double maxValue = BenchmarkResults.Max(r => r.Stats.RelativePerformance(referenceBenchmarkResults.Stats).AggregatedFrameRate);
        return Math.Ceiling((maxValue + 0.01) * 10) / 10;
    }
}
