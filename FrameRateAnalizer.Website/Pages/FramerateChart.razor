@using ApexCharts
@using FramerateAnalyzer.Domain

@if (BenchmarkResults != null && options != null)
{
    <ApexChart TItem="FrameRateBenchmarkResult" Title="@Title" Options=options>
        <ApexPointSeries TItem="FrameRateBenchmarkResult"
                         Items="BenchmarkResults"
                         Name="Average FPS"
                         SeriesType="SeriesType.Bar"
                         XValue="@(e => e.BenchmarkedParts)"
                         YValue="@(e => (decimal)e.Stats.Average)"
                         YAggregate="@(e => (decimal)(e.Sum(g => g.Stats.Average)))"
                         ShowDataLabels />

        <ApexPointSeries TItem="FrameRateBenchmarkResult"
                         Items="BenchmarkResults"
                         Name="10% Low Avg FPS"
                         SeriesType="SeriesType.Bar"
                         XValue="@(e => e.BenchmarkedParts)"
                         YValue="@(e => (decimal)e.Stats.TenPercentLowAverage)"
                         YAggregate="@(e => (decimal)(e.Sum(g => g.Stats.TenPercentLowAverage)))"
                         ShowDataLabels />

        <ApexPointSeries TItem="FrameRateBenchmarkResult"
                         Items="BenchmarkResults"
                         Name="1% Low Avg FPS"
                         SeriesType="SeriesType.Bar"
                         XValue="@(e => e.BenchmarkedParts)"
                         YValue="@(e => (decimal)e.Stats.OnePercentLowAverage)"
                         YAggregate="@(e => (decimal)(e.Sum(g => g.Stats.OnePercentLowAverage)))"
                         ShowDataLabels />

        <ApexPointSeries TItem="FrameRateBenchmarkResult"
                         Items="BenchmarkResults"
                         Name="0.1% Low Avg FPS"
                         SeriesType="SeriesType.Bar"
                         XValue="@(e => e.BenchmarkedParts)"
                         YValue="@(e => (decimal)e.Stats.ZeroPointOnePercentLowAverage)"
                         YAggregate="@(e => (decimal)(e.Sum(g => g.Stats.ZeroPointOnePercentLowAverage)))"
                         ShowDataLabels />    
    </ApexChart>
}

@code {
    [Parameter]
    public string? Title { get; set; }

    [Parameter]
    public IList<FrameRateBenchmarkResult>? BenchmarkResults { get; set; }

    private ApexChartOptions<FrameRateBenchmarkResult>? options;

    protected override void OnInitialized()
    {
        if (BenchmarkResults == null)
            return;

        options = new ApexChartOptions<FrameRateBenchmarkResult>
        {
            Title = new Title
            {
                Align = ApexCharts.Align.Center
            },
            // Stroke = new Stroke
            // {
            //     Colors = ["transparent"],
            //     Width = 2
            // },
            Chart = new Chart
            {
                Stacked = false,
                StackType = StackType.Normal,
                Toolbar = new Toolbar
                {
                    Show = false
                },
                Height = BenchmarkResults.Count * 100 + 100
            },
            PlotOptions = new PlotOptions
            {
                Bar = new PlotOptionsBar
                {
                    Horizontal = true,
                    BarHeight = "80%",
                    DataLabels = new PlotOptionsBarDataLabels
                    {
                        Position = BarDataLabelPosition.Top,  
                    }
                }
            },
            //Theme = new Theme { Mode = Mode.Light, Palette = PaletteType.Palette8 },
            Xaxis = new XAxis
            {
                Labels = new XAxisLabels
                {
                    Style = new AxisLabelStyle
                    {
                        FontSize = "0.875rem",
                        FontWeight = 500
                    },
                    Show = false
                },
                Categories = BenchmarkResults.Select(g => g.BenchmarkedParts).ToList()
            },
            Yaxis = new List<YAxis> { 
                new YAxis
                {
                    Labels = new YAxisLabels {
                        MaxWidth = 320,
                        Style = new AxisLabelStyle {
                            FontSize = "0.875rem",
                            FontWeight = 500
                        }
                    },
                    Max = BenchmarkResults.Max(r => r.Stats.Average),
                    DecimalsInFloat = 1 
                }
            },
            Legend = new Legend
            {
                Position = LegendPosition.Top
            },
            DataLabels = new DataLabels
            {
                Formatter = "function (val) { return val.toFixed(1); }",
                OffsetX = -25
            },
            Colors = [Colors.Blue.Darken1, Colors.Blue.Darken2, Colors.Blue.Darken3, Colors.Blue.Darken4],
            Tooltip = new ApexCharts.Tooltip
            {
                Enabled = false
            },
        };

        base.OnInitialized();
    }
}
